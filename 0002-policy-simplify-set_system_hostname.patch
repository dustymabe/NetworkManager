From ff9c310454e36acf996491ad154487c85b19f87a Mon Sep 17 00:00:00 2001
From: Beniamino Galvani <bgalvani@redhat.com>
Date: Mon, 22 Feb 2016 10:01:30 +0100
Subject: [PATCH 2/3] policy: simplify set_system_hostname()

Move some conditionals to the beginning of the function.
---
 src/nm-policy.c | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/src/nm-policy.c b/src/nm-policy.c
index cfb140f..fca4005 100644
--- a/src/nm-policy.c
+++ b/src/nm-policy.c
@@ -148,8 +148,13 @@ set_system_hostname (NMPolicy *self, const char *new_hostname, const char *msg)
 	const char *name;
 	int ret;
 
-	if (new_hostname)
-		g_warn_if_fail (strlen (new_hostname));
+	if (!new_hostname)
+		name = FALLBACK_HOSTNAME4;
+	else if (!new_hostname[0]) {
+		g_warn_if_reached ();
+		name = FALLBACK_HOSTNAME4;
+	} else
+		name = new_hostname;
 
 	old_hostname[HOST_NAME_MAX] = '\0';
 	errno = 0;
@@ -159,13 +164,10 @@ set_system_hostname (NMPolicy *self, const char *new_hostname, const char *msg)
 		             errno, strerror (errno));
 	} else {
 		/* Don't set the hostname if it isn't actually changing */
-		if (   (new_hostname && !strcmp (old_hostname, new_hostname))
-		       || (!new_hostname && !strcmp (old_hostname, FALLBACK_HOSTNAME4)))
+		if (nm_streq (name, old_hostname))
 			return;
 	}
 
-	name = (new_hostname && strlen (new_hostname)) ? new_hostname : FALLBACK_HOSTNAME4;
-
 	nm_log_info (LOGD_DNS, "Setting system hostname to '%s' (%s)", name, msg);
 	nm_settings_set_transient_hostname (priv->settings,
 	                                    name,
-- 
2.5.0

